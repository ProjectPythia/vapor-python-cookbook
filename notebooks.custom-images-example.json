{"version":2,"kind":"Notebook","sha256":"101046e8bff480dcdde98906a7f9c1dbd6312fc07d2f9d3814022363777c471e","slug":"notebooks.custom-images-example","location":"/notebooks/custom_images_example.ipynb","dependencies":[],"frontmatter":{"title":"Custom Map Images with Cartopy","content_includes_title":false,"kernelspec":{"name":"python3","display_name":"Feb18_vapor","language":"python"},"authors":[{"nameParsed":{"literal":"Project Pythia Community","given":"Project Pythia","family":"Community"},"name":"Project Pythia Community","url":"https://projectpythia.org/","id":"contributors-myst-generated-uid-0"}],"open_access":true,"license":{"content":{"id":"Apache-2.0","url":"https://opensource.org/licenses/Apache-2.0","name":"Apache License 2.0","free":true,"osi":true},"code":{"id":"CC-BY-4.0","url":"https://creativecommons.org/licenses/by/4.0/","name":"Creative Commons Attribution 4.0 International","free":true,"CC":true}},"github":"https://github.com/projectpythia/vapor-python-cookbook","copyright":"2024","affiliations":[{"id":"University at Albany (State University of New York)","name":"University at Albany (State University of New York)"},{"id":"UCAR/NCAR","name":"UCAR/NCAR"}],"numbering":{"title":{"offset":1}},"edit_url":"https://github.com/projectpythia/vapor-python-cookbook/blob/main/notebooks/custom_images_example.ipynb","exports":[{"format":"ipynb","filename":"custom_images_example.ipynb","url":"/vapor-python-cookbook/build/custom_images_exampl-2494721c093f116643ea29d63f78a77b.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Vapor has a built-in image renderer that can be used to draw land beneath your visualization. However, if you load the data using XArray or if the dataset lacks georeferencing information, the geographic extent of the image renderer will be incorrect. In this guide we will create a map image with custom bounds and custom Cartopy features that can be displayed with Vapor’s image renderer.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"g7yeVrSUHO"}],"key":"cQ85uUkCaS"}],"key":"xjpWYjP1fu"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Requirements","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"bXNToHtOjo"}],"identifier":"requirements","label":"Requirements","html_id":"requirements","implicit":true,"key":"fAV7nUArbq"}],"key":"DnP8d03gJk"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":5,"column":1}},"children":[{"type":"text","value":"This guide requires vapor and cartopy libraries. To access NASA satellite images, you will also need owslib: ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UQiJrz2UPV"},{"type":"break","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"tcyc3o37Hr"},{"type":"break","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"whM0RyJEG2"},{"type":"inlineCode","value":"conda install -c conda-forge -c ncar-vapor vapor","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"cfhVFuBeQv"},{"type":"break","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"YalNEelflY"},{"type":"inlineCode","value":"conda install conda-forge::cartopy","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hVJMYFVCXt"},{"type":"break","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"UJZlNpms9y"},{"type":"inlineCode","value":"conda install conda-forge::owslib","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PmwcHWfeQj"}],"key":"UitJdqZr7O"}],"key":"PRcnMAofnX"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Data download:\nimport os\nimport requests\nimport zipfile\n\n# Plotting libraries:\nimport matplotlib.pyplot as plt\nimport cartopy.crs as ccrs\nimport cartopy.feature as cf\n\n# Data handling:\nimport xarray as xr\nimport numpy as np\n\n# Vapor:\nfrom vapor import renderer, dataset, session","key":"nY1xtn52r1"},{"type":"output","id":"-XqJOpZKGJPisMIrirMSr","data":[{"output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mModuleNotFoundError\u001b[39m                       Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[1]\u001b[39m\u001b[32m, line 7\u001b[39m\n\u001b[32m      4\u001b[39m \u001b[38;5;28;01mimport\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mzipfile\u001b[39;00m\n\u001b[32m      6\u001b[39m \u001b[38;5;66;03m# Plotting libraries:\u001b[39;00m\n\u001b[32m----> \u001b[39m\u001b[32m7\u001b[39m \u001b[38;5;28;01mimport\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mmatplotlib\u001b[39;00m\u001b[34;01m.\u001b[39;00m\u001b[34;01mpyplot\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mas\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mplt\u001b[39;00m\n\u001b[32m      8\u001b[39m \u001b[38;5;28;01mimport\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mcartopy\u001b[39;00m\u001b[34;01m.\u001b[39;00m\u001b[34;01mcrs\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mas\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mccrs\u001b[39;00m\n\u001b[32m      9\u001b[39m \u001b[38;5;28;01mimport\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mcartopy\u001b[39;00m\u001b[34;01m.\u001b[39;00m\u001b[34;01mfeature\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[38;5;28;01mas\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34;01mcf\u001b[39;00m\n\n\u001b[31mModuleNotFoundError\u001b[39m: No module named 'matplotlib'","ename":"ModuleNotFoundError","evalue":"No module named 'matplotlib'"}],"key":"uNof96QgjV"}],"key":"ltleRXVwUO"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"We will also use vapor’s Katrina sample dataset:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"RvB6w8hOaj"}],"key":"bPKbsC3ZDJ"}],"key":"HtGjTq0hKW"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"### This cell installs vapor's Katrina sample dataset ###\nurl = 'https://data.rda.ucar.edu/ds897.7/Katrina.zip'\nextract_to = './data'\nzip_name = \"Katrina.zip\"\ndata_file = './data/wrfout_d02_2005-08-29_02.nc'\n\n# Check if the data file already exists\nif not os.path.exists(data_file):\n    # Download zip\n    with requests.get(url, stream=True) as r:\n        r.raise_for_status()\n        with open(zip_name, 'wb') as f:\n            for chunk in r.iter_content(chunk_size=8192):\n                f.write(chunk)\n    # Extract the file\n    with zipfile.ZipFile(zip_name, 'r') as zip_ref:\n        zip_ref.extractall(extract_to)\n\n    # Clean up the zip file\n    os.remove(zip_name)\n\n    print(f\"Data downloaded and extracted to {data_file}\")\nelse:\n    print(f\"Data file already exists at {data_file}, skipping download and extraction.\")\n","key":"Tzv3RronIV"},{"type":"output","id":"WoajlPgDGpiWyVYRIcpq0","data":[],"key":"FWSvV75ahB"}],"key":"QQhOONCVuf"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Select Parameters for our Image","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jvXyRtmOd6"}],"identifier":"select-parameters-for-our-image","label":"Select Parameters for our Image","html_id":"select-parameters-for-our-image","implicit":true,"key":"qlYvxYjjKa"}],"key":"kFjwv4c5BQ"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Specify where the new image file will be saved:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"nICAQ60Ofy"}],"key":"yyADDZjFi5"}],"key":"L1Uuy5ePBw"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"targetDir = \"\"\nfileName = \"Katrina_map_image\"","key":"ukqQpr2ud8"},{"type":"output","id":"QagFWHkg8lf8qQDuEmII8","data":[],"key":"wXD8qeLjpB"}],"key":"UPO099AlMn"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Specify the lon/lat bounds of your image. Make sure it is exactly the same as the geographic extent of your dataset:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"hXlbzYAzL3"}],"key":"Z7b9Zc9r8x"}],"key":"DmkbheVq2V"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"### If you know the extent of your dataset, you can set your bounds manually ###\n# west = -95.8826\n# north = 32.95732\n# east = -82.84012\n# south = 21.616137\n\n### Or you can extract this information from your dataset ###\nds = xr.open_dataset(\"data/wrfout_d02_2005-08-29_02.nc\")\nwest = np.min(ds[\"XLONG\"].values)\neast = np.max(ds[\"XLONG\"].values)\nsouth = np.min(ds[\"XLAT\"].values)\nnorth = np.max(ds[\"XLAT\"].values)\n","key":"P9SarXOvoO"},{"type":"output","id":"sWXC53VqkpWIBAp4rjURV","data":[],"key":"gnK8TwEHD4"}],"key":"fzi1k0myxU"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":4,"column":1}},"children":[{"type":"text","value":"Choose the size of your output figure. Note: If your specified lat/lon extents have a different aspect ratio than\nyour width and height, the geotiff will have either of its dimensions scaled to\nmatch the aspect ratio of the specified extents of the west/north/east/south\nvariables.","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"iEda3C2qdg"}],"key":"CWVQhbC7Ma"}],"key":"KWYj66CdNV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"width = 1920\nheight = 1080\ndpi = 42","key":"tUsg7EukbJ"},{"type":"output","id":"GpKHS6bkJSnjdyA-7H5uq","data":[],"key":"enfcubC8mb"}],"key":"KuJ9Cfp4PW"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Optional:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"HMNRlp430Q"}],"key":"bnQqZ7NTeL"},{"type":"text","value":" to include a satellite image, identify the url and layer of the image. The following cell selects a Blue Marble image from NASA. (You can try other layers, like the VIIRS city lights layer)","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"pSpQxcgugV"}],"key":"UqgEgwTZPa"}],"key":"KeHmlmMM51"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"url = \"https://map1c.vis.earthdata.nasa.gov/wmts-geo/wmts.cgi\"\nlayer = \"BlueMarble_ShadedRelief\"\n# layer = 'VIIRS_CityLights_2012'","key":"bjcRZPKHlv"},{"type":"output","id":"LvB4kJVXtbF4mfLjoTDVy","data":[],"key":"zrjz7ga33h"}],"key":"Y3AZWr9gUO"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Create a cartopy map","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"aBxvG2mgvv"}],"identifier":"create-a-cartopy-map","label":"Create a cartopy map","html_id":"create-a-cartopy-map","implicit":true,"key":"gKDxEzOZbc"}],"key":"SyfQYEwlPz"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Set up your figure and optionally add a satellite image","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"jdmBG8MvA7"}],"key":"sU9vCysUZI"}],"key":"dj0vdGivvL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"fig = plt.figure(\n    figsize=(width/dpi, height/dpi), \n    tight_layout=True \n)\nax = fig.add_subplot(1, 1, 1, projection=ccrs.PlateCarree())\n\nax.set_extent(\n    [west, east, south, north], \n    crs=ccrs.PlateCarree()\n)\n\nax.add_wmts(url, layer) # Adds the satellite image we chose in the previous cell. Remove this line for native Cartopy maps","key":"VlUcmGtYJ6"},{"type":"output","id":"hFy5_2_4bZXt5ViblaMFV","data":[],"key":"yPYEcDoOTt"}],"key":"NpwMMn3eHI"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Add Cartopy Features","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ifLH8RfTQG"}],"identifier":"add-cartopy-features","label":"Add Cartopy Features","html_id":"add-cartopy-features","implicit":true,"key":"sZ9Zti9afa"}],"key":"qvGnfgA7uH"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"For this example, we’ll add state borders, coastlines, and roads","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"fULA24zF1M"}],"key":"StNZA2iQGZ"}],"key":"QccwWXp2Tj"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Borders\nax.add_feature(\n    cf.STATES,\n    edgecolor='darkgray', \n    facecolor='none',\n    linewidth=3\n)","key":"CpvNePCwoN"},{"type":"output","id":"phWQ-lGl98lmorn3wEpjS","data":[],"key":"hpcbTNJTrO"}],"key":"B2X8AObLb3"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Coastlines\nax.add_feature(\n    cf.COASTLINE,\n    edgecolor='lightgray', \n    facecolor='none',\n    linewidth=3\n)","key":"Yk7PsHGbGj"},{"type":"output","id":"149Yn9UVkCMuF-mPNEXEg","data":[],"key":"FhrF4n8aVK"}],"key":"Szq2FWOgZL"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Roads\nax.add_feature(\n    cf.NaturalEarthFeature('cultural', 'roads_north_america', '10m'), \n    edgecolor='yellow', \n    facecolor='none'\n)","key":"YPpFot1nsH"},{"type":"output","id":"KJW7qYbbB0iEZVQtEkIIL","data":[],"key":"IbeDJQmv2L"}],"key":"ccXhSJPCTa"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"View and save image","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"PlwzMI1fEx"}],"identifier":"view-and-save-image","label":"View and save image","html_id":"view-and-save-image","implicit":true,"key":"kMc8VfEbsn"}],"key":"HB0KpRurl6"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# Save figure\ntiffFile = targetDir + fileName + \".tif\"\nfig.savefig( tiffFile,\n             bbox_inches='tight',\n             pad_inches=0\n)","key":"V0QdIu91yb"},{"type":"output","id":"jjRdieCLZxGbmhaSsNngn","data":[],"key":"HcM4J3WrDU"}],"key":"NIjp8Mjr4x"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"fig","key":"zi0jXDsqtS"},{"type":"output","id":"HeYBex5yzhamFXwg9kuZH","data":[],"key":"bpJV3Gbksk"}],"key":"oqlaUoeOv3"},{"type":"block","kind":"notebook-content","children":[{"type":"heading","depth":2,"position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Example: loading the map as an image in Vapor","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"p0urQaHYWu"}],"identifier":"example-loading-the-map-as-an-image-in-vapor","label":"Example: loading the map as an image in Vapor","html_id":"example-loading-the-map-as-an-image-in-vapor","implicit":true,"key":"NVv1fHm9Mh"}],"key":"kLKFd75jk6"},{"type":"block","kind":"notebook-content","children":[{"type":"paragraph","position":{"start":{"line":1,"column":1},"end":{"line":2,"column":1}},"children":[{"type":"text","value":"To view our map in Vapor, create an image renderer and set its path to the file we just created. ","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"KZqmrybJJn"},{"type":"break","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"W3czkl2m8s"},{"type":"strong","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"children":[{"type":"text","value":"Important:","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"ahmQaYCzXD"}],"key":"xpuRr1cHbG"},{"type":"text","value":" our image does not contain georeferencing information, to be sure the set ‘IsGeoRef’ to false","position":{"start":{"line":1,"column":1},"end":{"line":1,"column":1}},"key":"Idpjm7PV6U"}],"key":"gJ6XAgPxY3"}],"key":"SuO9b8yvmV"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"ses = session.Session()\ndata = ses.OpenDataset(dataset.WRF, [\"data/wrfout_d02_2005-08-29_02.nc\"])\nimage = data.NewRenderer(renderer.ImageRenderer)\nimage.SetImagePath(\"./Katrina_map_image.tif\")\nimage.SetIsGeoRef(False)\n\n# Add visualization of the hurricane's clouds\nclouds = data.NewRenderer(renderer.VolumeRenderer) # Render clouds\nclouds.SetVariableName(\"QCLOUD\")\nclouds_tf = clouds.GetTransferFunction(\"QCLOUD\")\nclouds_tf.LoadBuiltinColormap(\"Sequential/BlackWhite\")\nclouds_tf.SetColorRGBList([(r, g, b) for r, g, b, _ in \n                           list(reversed(clouds_tf.GetMatPlotLibColormap().colors))])\nclouds_tf.SetOpacityControlPoints([[0,0],[0.00001,0.01], [0.0001, 0.1], [0.0010,0.9]])\nses.GetCamera().LookAt([-1190444, 1882360, 770176], [-420811, 2737271, 5699], [0.41853764, 0.35630071, 0.83538976])\nses.Show()","key":"a1ZD0dYzwp"},{"type":"output","id":"bSFYCpQlQtOMycjcBQ6-v","data":[],"key":"S7W4tiR1oi"}],"key":"gIAPVFJKv5"}],"key":"gvg7OhEvjS"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Visualizer Widgets","url":"/notebooks/visualizer-widget-example","group":"Foundations of VAPOR Python"},"next":{"title":"AGU 2023 Tutorial: Visualizing 2D and 3D Geoscience Data in Python","url":"/notebooks/agu-2023-example","group":"Example workflows"}}},"domain":"http://localhost:3000"}